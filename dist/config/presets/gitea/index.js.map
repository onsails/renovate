{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../lib/config/presets/gitea/index.ts"],"names":[],"mappings":";;;AAAA,4CAAyC;AACzC,uEAG8C;AAC9C,mFAA8E;AAE9E,kCAA4D;AAE/C,QAAA,QAAQ,GAAG,2BAA2B,CAAC;AAE7C,KAAK,UAAU,aAAa,CACjC,IAAY,EACZ,QAAgB,EAChB,QAAgB;IAEhB,IAAI,GAAiB,CAAC;IACtB,IAAI;QACF,GAAG,GAAG,MAAM,8BAAe,CAAC,IAAI,EAAE,QAAQ,EAAE,IAAI,EAAE,EAAE,OAAO,EAAE,QAAQ,EAAE,CAAC,CAAC;KAC1E;IAAC,OAAO,GAAG,EAAE;QACZ,6CAA6C;QAC7C,IAAI,GAAG,YAAY,uCAAiB,EAAE;YACpC,MAAM,GAAG,CAAC;SACX;QACD,eAAM,CAAC,KAAK,CACV,EAAE,UAAU,EAAE,GAAG,CAAC,UAAU,EAAE,IAAI,EAAE,QAAQ,EAAE,EAC9C,sBAAsB,QAAQ,YAAY,CAC3C,CAAC;QACF,MAAM,IAAI,KAAK,CAAC,2BAAoB,CAAC,CAAC;KACvC;IACD,IAAI;QACF,MAAM,OAAO,GAAG,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,OAAO,EAAE,QAAQ,CAAC,CAAC,QAAQ,EAAE,CAAC;QAC9D,MAAM,MAAM,GAAG,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC;QACnC,OAAO,MAAM,CAAC;KACf;IAAC,OAAO,GAAG,EAAE;QACZ,MAAM,IAAI,KAAK,CAAC,qBAAqB,CAAC,CAAC;KACxC;AACH,CAAC;AA1BD,sCA0BC;AAED,SAAgB,qBAAqB,CACnC,OAAe,EACf,UAAkB,EAClB,QAAQ,GAAG,gBAAQ;IAEnB,OAAO,kBAAW,CAAC;QACjB,OAAO;QACP,UAAU;QACV,QAAQ;QACR,KAAK,EAAE,aAAa;KACrB,CAAC,CAAC;AACL,CAAC;AAXD,sDAWC;AAED,SAAgB,SAAS,CAAC,EACxB,WAAW,EAAE,OAAO,EACpB,UAAU,GAAG,SAAS,GACT;IACb,OAAO,qBAAqB,CAAC,OAAO,EAAE,UAAU,EAAE,gBAAQ,CAAC,CAAC;AAC9D,CAAC;AALD,8BAKC","sourcesContent":["import { logger } from '../../../logger';\nimport {\n  RepoContents,\n  getRepoContents,\n} from '../../../platform/gitea/gitea-helper';\nimport { ExternalHostError } from '../../../types/errors/external-host-error';\nimport { Preset, PresetConfig } from '../common';\nimport { PRESET_DEP_NOT_FOUND, fetchPreset } from '../util';\n\nexport const Endpoint = 'https://gitea.com/api/v1/';\n\nexport async function fetchJSONFile(\n  repo: string,\n  fileName: string,\n  endpoint: string\n): Promise<Preset> {\n  let res: RepoContents;\n  try {\n    res = await getRepoContents(repo, fileName, null, { baseUrl: endpoint });\n  } catch (err) {\n    // istanbul ignore if: not testable with nock\n    if (err instanceof ExternalHostError) {\n      throw err;\n    }\n    logger.debug(\n      { statusCode: err.statusCode, repo, fileName },\n      `Failed to retrieve ${fileName} from repo`\n    );\n    throw new Error(PRESET_DEP_NOT_FOUND);\n  }\n  try {\n    const content = Buffer.from(res.content, 'base64').toString();\n    const parsed = JSON.parse(content);\n    return parsed;\n  } catch (err) {\n    throw new Error('invalid preset JSON');\n  }\n}\n\nexport function getPresetFromEndpoint(\n  pkgName: string,\n  filePreset: string,\n  endpoint = Endpoint\n): Promise<Preset> {\n  return fetchPreset({\n    pkgName,\n    filePreset,\n    endpoint,\n    fetch: fetchJSONFile,\n  });\n}\n\nexport function getPreset({\n  packageName: pkgName,\n  presetName = 'default',\n}: PresetConfig): Promise<Preset> {\n  return getPresetFromEndpoint(pkgName, presetName, Endpoint);\n}\n"]}