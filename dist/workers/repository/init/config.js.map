{"version":3,"file":"config.js","sourceRoot":"","sources":["../../../../lib/workers/repository/init/config.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport jsonValidator from 'json-dup-key-validator';\nimport JSON5 from 'json5';\nimport upath from 'upath';\n\nimport { RenovateConfig, mergeChildConfig } from '../../../config';\nimport { configFileNames } from '../../../config/app-strings';\nimport { decryptConfig } from '../../../config/decrypt';\nimport { migrateAndValidate } from '../../../config/migrate-validate';\nimport * as presets from '../../../config/presets';\nimport {\n  CONFIG_VALIDATION,\n  REPOSITORY_CHANGED,\n} from '../../../constants/error-messages';\nimport * as npmApi from '../../../datasource/npm';\nimport { logger } from '../../../logger';\nimport { readLocalFile } from '../../../util/fs';\nimport { getFileList } from '../../../util/git';\nimport * as hostRules from '../../../util/host-rules';\nimport { checkOnboardingBranch } from '../onboarding/branch';\nimport { RepoFileConfig } from './common';\nimport { flattenPackageRules } from './flatten';\nimport { detectSemanticCommits } from './semantic';\n\nexport async function detectRepoFileConfig(): Promise<RepoFileConfig> {\n  const fileList = await getFileList();\n  async function detectConfigFile(): Promise<string | null> {\n    for (const configFileName of configFileNames) {\n      if (configFileName === 'package.json') {\n        try {\n          const pJson = JSON.parse(await readLocalFile('package.json', 'utf8'));\n          if (pJson.renovate) {\n            logger.debug('Using package.json for global renovate config');\n            return 'package.json';\n          }\n        } catch (err) {\n          // Do nothing\n        }\n      } else if (fileList.includes(configFileName)) {\n        return configFileName;\n      }\n    }\n    return null;\n  }\n  const configFileName = await detectConfigFile();\n  if (!configFileName) {\n    logger.debug('No renovate config file found');\n    return {};\n  }\n  logger.debug(`Found ${configFileName} config file`);\n  let configFileParsed;\n  if (configFileName === 'package.json') {\n    // We already know it parses\n    configFileParsed = JSON.parse(await readLocalFile('package.json', 'utf8'))\n      .renovate;\n    logger.debug({ config: configFileParsed }, 'package.json>renovate config');\n  } else {\n    let rawFileContents = await readLocalFile(configFileName, 'utf8');\n    // istanbul ignore if\n    if (!rawFileContents) {\n      logger.warn({ configFileName }, 'Null contents when reading config file');\n      throw new Error(REPOSITORY_CHANGED);\n    }\n    // istanbul ignore if\n    if (!rawFileContents.length) {\n      rawFileContents = '{}';\n    }\n\n    const fileType = upath.extname(configFileName);\n\n    if (fileType === '.json5') {\n      try {\n        configFileParsed = JSON5.parse(rawFileContents);\n      } catch (err) /* istanbul ignore next */ {\n        logger.debug(\n          { renovateConfig: rawFileContents },\n          'Error parsing renovate config renovate.json5'\n        );\n        const validationError = 'Invalid JSON5 (parsing failed)';\n        const validationMessage = `JSON5.parse error:  ${String(err.message)}`;\n        return {\n          configFileName,\n          configFileParseError: { validationError, validationMessage },\n        };\n      }\n    } else {\n      let allowDuplicateKeys = true;\n      let jsonValidationError = jsonValidator.validate(\n        rawFileContents,\n        allowDuplicateKeys\n      );\n      if (jsonValidationError) {\n        const validationError = 'Invalid JSON (parsing failed)';\n        const validationMessage = jsonValidationError;\n        return {\n          configFileName,\n          configFileParseError: { validationError, validationMessage },\n        };\n      }\n      allowDuplicateKeys = false;\n      jsonValidationError = jsonValidator.validate(\n        rawFileContents,\n        allowDuplicateKeys\n      );\n      if (jsonValidationError) {\n        const validationError = 'Duplicate keys in JSON';\n        const validationMessage = JSON.stringify(jsonValidationError);\n        return {\n          configFileName,\n          configFileParseError: { validationError, validationMessage },\n        };\n      }\n      try {\n        configFileParsed = JSON.parse(rawFileContents);\n      } catch (err) /* istanbul ignore next */ {\n        logger.debug(\n          { renovateConfig: rawFileContents },\n          'Error parsing renovate config'\n        );\n        const validationError = 'Invalid JSON (parsing failed)';\n        const validationMessage = `JSON.parse error:  ${String(err.message)}`;\n        return {\n          configFileName,\n          configFileParseError: { validationError, validationMessage },\n        };\n      }\n    }\n    logger.debug(\n      { fileName: configFileName, config: configFileParsed },\n      'Repository config'\n    );\n  }\n  return { configFileName, configFileParsed };\n}\n\nexport function checkForRepoConfigError(repoConfig: RepoFileConfig): void {\n  if (!repoConfig.configFileParseError) {\n    return;\n  }\n  const error = new Error(CONFIG_VALIDATION);\n  error.configFile = repoConfig.configFileName;\n  error.validationError = repoConfig.configFileParseError.validationError;\n  error.validationMessage = repoConfig.configFileParseError.validationMessage;\n  throw error;\n}\n\n// Check for repository config\nexport async function mergeRenovateConfig(\n  config: RenovateConfig\n): Promise<RenovateConfig> {\n  let returnConfig = { ...config };\n  const repoConfig = await detectRepoFileConfig();\n  const configFileParsed = repoConfig?.configFileParsed || {};\n  if (is.nonEmptyArray(returnConfig.extends)) {\n    configFileParsed.extends = [\n      ...returnConfig.extends,\n      ...(configFileParsed.extends || []),\n    ];\n    delete returnConfig.extends;\n  }\n  checkForRepoConfigError(repoConfig);\n  const migratedConfig = await migrateAndValidate(config, configFileParsed);\n  if (migratedConfig.errors.length) {\n    const error = new Error(CONFIG_VALIDATION);\n    error.configFile = repoConfig.configFileName;\n    error.validationError =\n      'The renovate configuration file contains some invalid settings';\n    error.validationMessage = migratedConfig.errors\n      .map((e) => e.message)\n      .join(', ');\n    throw error;\n  }\n  if (migratedConfig.warnings) {\n    returnConfig.warnings = returnConfig.warnings.concat(\n      migratedConfig.warnings\n    );\n  }\n  delete migratedConfig.errors;\n  delete migratedConfig.warnings;\n  logger.debug({ config: migratedConfig }, 'migrated config');\n  // Decrypt before resolving in case we need npm authentication for any presets\n  const decryptedConfig = decryptConfig(migratedConfig, config.privateKey);\n  // istanbul ignore if\n  if (decryptedConfig.npmrc) {\n    logger.debug('Found npmrc in decrypted config - setting');\n    npmApi.setNpmrc(decryptedConfig.npmrc);\n  }\n  // Decrypt after resolving in case the preset contains npm authentication instead\n  const resolvedConfig = decryptConfig(\n    await presets.resolveConfigPresets(decryptedConfig, config),\n    config.privateKey\n  );\n  delete resolvedConfig.privateKey;\n  logger.trace({ config: resolvedConfig }, 'resolved config');\n  // istanbul ignore if\n  if (resolvedConfig.npmrc) {\n    logger.debug(\n      'Ignoring any .npmrc files in repository due to configured npmrc'\n    );\n    npmApi.setNpmrc(resolvedConfig.npmrc);\n    resolvedConfig.ignoreNpmrcFile = true;\n  }\n  // istanbul ignore if\n  if (resolvedConfig.hostRules) {\n    logger.debug('Setting hostRules from config');\n    for (const rule of resolvedConfig.hostRules) {\n      try {\n        hostRules.add(rule);\n      } catch (err) {\n        logger.warn(\n          { err, config: rule },\n          'Error setting hostRule from config'\n        );\n      }\n    }\n    delete resolvedConfig.hostRules;\n  }\n  returnConfig = mergeChildConfig(returnConfig, resolvedConfig);\n  returnConfig.renovateJsonPresent = true;\n  returnConfig.packageRules = flattenPackageRules(returnConfig.packageRules);\n  // istanbul ignore if\n  if (returnConfig.ignorePaths?.length) {\n    logger.debug(\n      { ignorePaths: returnConfig.ignorePaths },\n      `Found repo ignorePaths`\n    );\n  }\n  return returnConfig;\n}\n\n// istanbul ignore next\nexport async function getRepoConfig(\n  config_: RenovateConfig\n): Promise<RenovateConfig> {\n  let config = { ...config_ };\n  config.baseBranch = config.defaultBranch;\n  config = await checkOnboardingBranch(config);\n  config = await mergeRenovateConfig(config);\n  if (config.semanticCommits === 'auto') {\n    config.semanticCommits = await detectSemanticCommits();\n  }\n  return config;\n}\n"]}