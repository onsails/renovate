{"version":3,"file":"extract.js","sourceRoot":"","sources":["../../../lib/manager/helm-values/extract.ts"],"names":[],"mappings":";;;;;;AAAA,sDAA2B;AAC3B,yCAAsC;AACtC,oDAAiE;AAEjE,mDAA+C;AAE/C,iCAGgB;AAEhB,SAAS,UAAU,CAAC,EAClB,QAAQ,EACR,UAAU,EACV,GAAG,GAKJ;IACC,MAAM,GAAG,GAAG,gBAAM,CAAC,GAAG,QAAQ,GAAG,UAAU,IAAI,GAAG,EAAE,EAAE,KAAK,CAAC,CAAC;IAC7D,GAAG,CAAC,aAAa,GAAG,GAAG,CAAC;IACxB,GAAG,CAAC,UAAU,GAAG,WAAgB,CAAC;IAClC,OAAO,GAAG,CAAC;AACb,CAAC;AAED;;;;GAIG;AACH,SAAS,gBAAgB,CACvB,aAAkE,EAClE,mBAA6C;IAE7C,IAAI,CAAC,aAAa,IAAI,OAAO,aAAa,KAAK,QAAQ,EAAE;QACvD,OAAO,mBAAmB,CAAC;KAC5B;IAED,MAAM,CAAC,IAAI,CAAC,aAAa,CAAC,CAAC,OAAO,CAAC,CAAC,GAAG,EAAE,EAAE;QACzC,IAAI,uCAAgC,CAAC,GAAG,EAAE,aAAa,CAAC,GAAG,CAAC,CAAC,EAAE;YAC7D,MAAM,WAAW,GAAG,aAAa,CAAC,GAAG,CAAC,CAAC;YAEvC,IAAI,QAAQ,GAAW,WAAW,CAAC,QAAQ,CAAC;YAC5C,QAAQ,GAAG,QAAQ,CAAC,CAAC,CAAC,GAAG,QAAQ,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC;YAC1C,MAAM,UAAU,GAAG,MAAM,CAAC,WAAW,CAAC,UAAU,CAAC,CAAC;YAClD,MAAM,GAAG,GAAG,MAAM,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC;YACpC,mBAAmB,CAAC,IAAI,CAAC,UAAU,CAAC,EAAE,UAAU,EAAE,GAAG,EAAE,QAAQ,EAAE,CAAC,CAAC,CAAC;SACrE;aAAM;YACL,gBAAgB,CAAC,aAAa,CAAC,GAAG,CAAC,EAAE,mBAAmB,CAAC,CAAC;SAC3D;IACH,CAAC,CAAC,CAAC;IACH,OAAO,mBAAmB,CAAC;AAC7B,CAAC;AAED,SAAgB,kBAAkB,CAAC,OAAe;IAChD,IAAI,aAAkE,CAAC;IACvE,IAAI;QACF,yEAAyE;QACzE,iFAAiF;QACjF,eAAe;QACf,aAAa,GAAG,iBAAI,CAAC,QAAQ,CAAC,OAAO,EAAE,EAAE,IAAI,EAAE,IAAI,EAAE,CAAQ,CAAC;KAC/D;IAAC,OAAO,GAAG,EAAE;QACZ,eAAM,CAAC,KAAK,CAAC,EAAE,GAAG,EAAE,EAAE,kCAAkC,CAAC,CAAC;QAC1D,OAAO,IAAI,CAAC;KACb;IACD,IAAI;QACF,MAAM,IAAI,GAAG,gBAAgB,CAAC,aAAa,EAAE,EAAE,CAAC,CAAC;QACjD,IAAI,IAAI,CAAC,MAAM,EAAE;YACf,eAAM,CAAC,KAAK,CAAC,EAAE,IAAI,EAAE,EAAE,mCAAmC,CAAC,CAAC;YAC5D,OAAO,EAAE,IAAI,EAAE,CAAC;SACjB;KACF;IAAC,OAAO,GAAG,EAAE,0BAA0B,CAAC;QACvC,eAAM,CAAC,KAAK,CAAC,EAAE,GAAG,EAAE,EAAE,0CAA0C,CAAC,CAAC;KACnE;IACD,OAAO,IAAI,CAAC;AACd,CAAC;AArBD,gDAqBC","sourcesContent":["import yaml from 'js-yaml';\nimport { logger } from '../../logger';\nimport { id as dockerVersioning } from '../../versioning/docker';\nimport { PackageDependency, PackageFile } from '../common';\nimport { getDep } from '../dockerfile/extract';\n\nimport {\n  HelmDockerImageDependency,\n  matchesHelmValuesDockerHeuristic,\n} from './util';\n\nfunction getHelmDep({\n  registry,\n  repository,\n  tag,\n}: {\n  registry: string;\n  repository: string;\n  tag: string;\n}): PackageDependency {\n  const dep = getDep(`${registry}${repository}:${tag}`, false);\n  dep.replaceString = tag;\n  dep.versioning = dockerVersioning;\n  return dep;\n}\n\n/**\n * Recursively find all supported dependencies in the yaml object.\n *\n * @param parsedContent\n */\nfunction findDependencies(\n  parsedContent: Record<string, unknown> | HelmDockerImageDependency,\n  packageDependencies: Array<PackageDependency>\n): Array<PackageDependency> {\n  if (!parsedContent || typeof parsedContent !== 'object') {\n    return packageDependencies;\n  }\n\n  Object.keys(parsedContent).forEach((key) => {\n    if (matchesHelmValuesDockerHeuristic(key, parsedContent[key])) {\n      const currentItem = parsedContent[key];\n\n      let registry: string = currentItem.registry;\n      registry = registry ? `${registry}/` : '';\n      const repository = String(currentItem.repository);\n      const tag = String(currentItem.tag);\n      packageDependencies.push(getHelmDep({ repository, tag, registry }));\n    } else {\n      findDependencies(parsedContent[key], packageDependencies);\n    }\n  });\n  return packageDependencies;\n}\n\nexport function extractPackageFile(content: string): PackageFile {\n  let parsedContent: Record<string, unknown> | HelmDockerImageDependency;\n  try {\n    // a parser that allows extracting line numbers would be preferable, with\n    // the current approach we need to match anything we find again during the update\n    // TODO: fix me\n    parsedContent = yaml.safeLoad(content, { json: true }) as any;\n  } catch (err) {\n    logger.debug({ err }, 'Failed to parse helm-values YAML');\n    return null;\n  }\n  try {\n    const deps = findDependencies(parsedContent, []);\n    if (deps.length) {\n      logger.debug({ deps }, 'Found dependencies in helm-values');\n      return { deps };\n    }\n  } catch (err) /* istanbul ignore next */ {\n    logger.error({ err }, 'Error parsing helm-values parsed content');\n  }\n  return null;\n}\n"]}